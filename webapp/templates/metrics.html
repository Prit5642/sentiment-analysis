{% extends "base.html" %}

{% block title %}Metrics Dashboard - Sentiment Analysis{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-dashboard"></i> System Dashboard</h2>
            <div>
                <a href="http://localhost:9090" target="_blank" class="btn btn-outline-primary">
                    <i class="fas fa-chart-bar"></i> Prometheus
                </a>
                <a href="http://localhost:3000" target="_blank" class="btn btn-outline-success">
                    <i class="fas fa-tachometer-alt"></i> Grafana
                </a>
                <a href="/metrics" target="_blank" class="btn btn-outline-info">
                    <i class="fas fa-code"></i> Raw Metrics
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_predictions }}</h4>
                        <p class="card-text">Total Predictions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.recent_predictions }}</h4>
                        <p class="card-text">Last 24 Hours</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ "%.1f"|format(stats.avg_confidence * 100) }}%</h4>
                        <p class="card-text">Avg Confidence</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-percentage fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ "%.3f"|format(stats.avg_processing_time) }}s</h4>
                        <p class="card-text">Avg Processing Time</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-stopwatch fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sentiment Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Sentiment Distribution</h5>
            </div>
            <div class="card-body">
                <div id="sentimentChart" style="height: 300px;">
                    <canvas id="sentimentPieChart"></canvas>
                </div>
                <div class="mt-3">
                    {% for sentiment, count in stats.sentiment_distribution.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>
                            <span
                                class="badge {{ 'bg-success' if sentiment == 'Positive' else 'bg-danger' if sentiment == 'Negative' else 'bg-warning' }}">
                                {{ sentiment }}
                            </span>
                        </span>
                        <span class="fw-bold">{{ count }} predictions</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tachometer-alt"></i> Performance Metrics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-bolt fa-2x text-success mb-2"></i>
                            <h5>{{ "%.3f"|format(stats.avg_processing_time) }}s</h5>
                            <small class="text-muted">Avg Response Time</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                            <h5>{{ "%.1f"|format(stats.avg_confidence * 100) }}%</h5>
                            <small class="text-muted">Avg Confidence</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-3">
                            <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                            <h5>{{ stats.recent_predictions }}</h5>
                            <small class="text-muted">Predictions (24h)</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-3">
                            <i class="fas fa-database fa-2x text-warning mb-2"></i>
                            <h5>{{ stats.total_predictions }}</h5>
                            <small class="text-muted">Total in DB</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Real-time Monitoring Links -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-external-link-alt"></i> Monitoring Dashboards</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="http://localhost:3000" target="_blank" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-tachometer-alt text-success"></i> Grafana Main Dashboard
                            </h6>
                            <small class="text-muted">Port 3000</small>
                        </div>
                        <p class="mb-1">Advanced visualization and alerting dashboard with custom metrics.</p>
                    </a>
                    <a href="http://localhost:9090" target="_blank" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-chart-bar text-primary"></i> Prometheus Metrics</h6>
                            <small class="text-muted">Port 9090</small>
                        </div>
                        <p class="mb-1">Raw metrics and query interface for detailed analysis.</p>
                    </a>
                    <a href="http://localhost:5001" target="_blank" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-database text-info"></i> Database API</h6>
                            <small class="text-muted">Port 5001</small>
                        </div>
                        <p class="mb-1">REST API for prediction data and statistics.</p>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> System Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6>Services Status</h6>
                        <ul class="list-unstyled">
                            <li>
                                <i class="fas fa-circle text-success"></i>
                                <small>Web Application (Port 5000)</small>
                            </li>
                            <li>
                                <i class="fas fa-circle text-success"></i>
                                <small>Database API (Port 5001)</small>
                            </li>
                            <li>
                                <i class="fas fa-circle text-success"></i>
                                <small>Prometheus (Port 9090)</small>
                            </li>
                            <li>
                                <i class="fas fa-circle text-success"></i>
                                <small>Grafana (Port 3000)</small>
                            </li>
                        </ul>
                    </div>
                    <div class="col-6">
                        <h6>Key Metrics</h6>
                        <ul class="list-unstyled">
                            <li><small>Predictions: {{ stats.total_predictions }}</small></li>
                            <li><small>Avg Confidence: {{ "%.1f"|format(stats.avg_confidence * 100) }}%</small></li>
                            <li><small>Response Time: {{ "%.3f"|format(stats.avg_processing_time) }}s</small></li>
                            <li><small>Uptime: <span id="uptime">Calculating...</span></small></li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Quick Actions</h6>
                    <div class="btn-group w-100">
                        <a href="/predict" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-play"></i> New Prediction
                        </a>
                        <a href="/history" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-history"></i> View History
                        </a>
                        <button onclick="refreshDashboard()" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Metrics Updates -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-heartbeat"></i> Real-time System Metrics</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="liveUpdateSwitch" checked>
                    <label class="form-check-label" for="liveUpdateSwitch">Live Updates</label>
                </div>
            </div>
            <div class="card-body">
                <div class="row text-center" id="liveMetrics">
                    <div class="col-md-2 col-6 mb-3">
                        <div class="border rounded p-2 bg-light">
                            <small class="text-muted d-block">Active Requests</small>
                            <h4 class="mb-0 text-primary" id="activeRequests">0</h4>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="border rounded p-2 bg-light">
                            <small class="text-muted d-block">Success Rate</small>
                            <h4 class="mb-0 text-success" id="successRate">100%</h4>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="border rounded p-2 bg-light">
                            <small class="text-muted d-block">Error Rate</small>
                            <h4 class="mb-0 text-danger" id="errorRate">0%</h4>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="border rounded p-2 bg-light">
                            <small class="text-muted d-block">Avg Confidence</small>
                            <h4 class="mb-0 text-info" id="avgConfidence">0%</h4>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="border rounded p-2 bg-light">
                            <small class="text-muted d-block">Throughput</small>
                            <h4 class="mb-0 text-warning" id="throughput">0/min</h4>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 mb-3">
                        <div class="border rounded p-2 bg-light">
                            <small class="text-muted d-block">Response Time</small>
                            <h4 class="mb-0 text-secondary" id="responseTime">0ms</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function () {
        initializeSentimentChart();
        startLiveUpdates();
        calculateUptime();
    });

    function initializeSentimentChart() {
        const ctx = document.getElementById('sentimentPieChart').getContext('2d');
        const sentimentData = {
        {% for sentiment, count in stats.sentiment_distribution.items() %}
        '{{ sentiment }}': { { count } },
        {% endfor %}
    };

    const colors = {
        'Positive': '#28a745',
        'Negative': '#dc3545',
        'Neutral': '#ffc107'
    };

    const chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(sentimentData),
            datasets: [{
                data: Object.values(sentimentData),
                backgroundColor: Object.keys(sentimentData).map(sentiment => colors[sentiment] || '#6c757d'),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

    function startLiveUpdates() {
        let updateInterval;

        function updateMetrics() {
            fetch('/metrics')
                .then(response => response.text())
                .then(data => {
                    // Parse Prometheus metrics (simplified)
                    const lines = data.split('\n');
                    let activeRequests = 0;
                    let successCount = 0;
                    let errorCount = 0;

                    lines.forEach(line => {
                        if (line.startsWith('active_requests')) {
                            activeRequests = parseFloat(line.split(' ')[1]) || 0;
                        }
                        if (line.includes('sentiment_predictions_total') && line.includes('status="success"')) {
                            successCount = parseFloat(line.split(' ')[1]) || 0;
                        }
                        if (line.includes('sentiment_predictions_total') && line.includes('status="error"')) {
                            errorCount = parseFloat(line.split(' ')[1]) || 0;
                        }
                    });

                    const total = successCount + errorCount;
                    const successRate = total > 0 ? (successCount / total * 100).toFixed(1) : 100;
                    const errorRate = total > 0 ? (errorCount / total * 100).toFixed(1) : 0;

                    document.getElementById('activeRequests').textContent = activeRequests;
                    document.getElementById('successRate').textContent = successRate + '%';
                    document.getElementById('errorRate').textContent = errorRate + '%';

                    // Simulate other metrics for demo
                    document.getElementById('avgConfidence').textContent =
                        (70 + Math.random() * 10).toFixed(1) + '%';
                    document.getElementById('throughput').textContent =
                        Math.floor(5 + Math.random() * 10) + '/min';
                    document.getElementById('responseTime').textContent =
                        (50 + Math.random() * 50).toFixed(0) + 'ms';
                })
                .catch(error => {
                    console.error('Error fetching metrics:', error);
                });
        }

        // Initial update
        updateMetrics();

        // Set up interval
        updateInterval = setInterval(updateMetrics, 5000);

        // Handle live update toggle
        document.getElementById('liveUpdateSwitch').addEventListener('change', function (e) {
            if (e.target.checked) {
                updateInterval = setInterval(updateMetrics, 5000);
            } else {
                clearInterval(updateInterval);
            }
        });
    }

    function calculateUptime() {
        // Simple uptime calculation (in a real app, this would come from the server)
        const startTime = Date.now() - (Math.random() * 24 * 60 * 60 * 1000); // Random start within 24h
        const uptime = Date.now() - startTime;
        const hours = Math.floor(uptime / (1000 * 60 * 60));
        const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
        document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
    }

    function refreshDashboard() {
        window.location.reload();
    }

    // Auto-refresh every 30 seconds if live updates are enabled
    setInterval(() => {
        if (document.getElementById('liveUpdateSwitch').checked) {
            refreshDashboard();
        }
    }, 30000);
</script>
{% endblock %}